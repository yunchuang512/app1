<!DOCTYPE html>
<html class="ui-page-login">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title></title>
	<link href="../css/mui.min.css" rel="stylesheet" />
	<link href="../css/style.css" rel="stylesheet" />
	<link rel="stylesheet" href="../css/mydefine.css">
	<link rel="stylesheet" href="../css/style1.css">
	<script src="../js/jquery-3.1.1.min.js"></script>
	<script src="../js/app.js"></script>
	<style type="text/css">
		.mui-popup-button {
			color: #FB5237;
			font-size: 0.31rem;
			height: 0.83rem;
		}
		.mui-popup-title {
			padding-top: 0.21rem;
			color: #333333;
			font-size: 0.31rem;
			font-weight: bold;
			width: 4.79rem;
		}
		.mui-popup-text {
			color: #333333;
			font-size: 0.31rem;
		}

		.myicon {
			font-size: 0.3rem;
			line-height: 1rem;
			color: #FB5237;
			margin-left: 0.21rem;
			margin-right: 0.21rem;
		}

		.mui-bar-nav~.mui-content{
			padding-top: 0.88rem;
		}
		
		.mui-icon-clear{
			line-height: 1rem;
		}
	</style>
</head>

<body>
<header class="mui-bar mui-bar-nav" style="background-color: #FFFFFF;height: 0.88rem">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #333333;line-height: 0.88rem;padding: 0;margin: 0;"></a>
	<h1 class="mui-title" style="color: #333333;font-size: 0.32rem;margin-right: 0.21rem;padding-left: 0.21rem;line-height: 0.88rem;font-weight: normal;">注册(2/2)</h1>
</header>
<div align="center" class="mui-content" style="background-color: #FFFFFF;padding-top: 1.67rem;">
	<span style="color: #333333;font-size: 0.38rem;">验证码已发送至</span>
	<span id="phonenumberbox" style="color: #333333;font-size: 0.38rem;">150****5862</span>
	<div align="left" style="border:0;border-bottom:#d5d5d5 0.02rem solid;margin: 0.8rem 3% 0 3%;height: 1rem;">
		<div class="mui-icon icon-shouji myicon" style="margin-left: 2%; margin-right: 2%;color: #FB5237; width: auto;"></div>
		<input id="verifyCode" type="tel" placeholder="请输入验证码" style=" font-size:0.28rem ; line-height:0.4rem;height:0.4rem;border: 0; width: 45%; margin-bottom: 0;padding: 0;">
		<button id='sendcode_button' type="button" class="mui-btn mui-btn-primary" data-loading-icon="" style="font-size: 0.24rem;height: 0.6rem;line-height: 0.24rem;margin-top: 0.2rem; background-color: #eeeeee;
		color: #999999;border: none;float: right;">发送验证码</button>
	</div>
	<div align="left" class="mui-input-row" style="border:0;border-bottom:#d5d5d5 0.02rem solid;height: 1rem;margin: 0 3% 0 3%;">
		<div class="mui-icon icon-mima myicon" style="margin-left: 2%; margin-right: 2%;color: #FB5237;"></div>
		<input id="password" class="mui-input-clear" type="password" placeholder="请输入密码" style="font-size:0.28rem ; line-height:0.4rem;height:0.4rem;
		border: 0; width: 80%; margin-bottom: 0;padding: 0;">
	</div>
	<div style="margin: 4%;">
		<button id='submit' class="mui-btn mui-btn-block" style="border: 0; font-size: 0.29rem; height: 0.92rem; padding:0; background-color:#eeeeee; margin-top:1.25rem;color:#999999">完成</button>
	</div>
	<p id="noverify" style="float: right; font-size: 0.25rem; margin-right: 0.21rem; color: #999999;">收不到验证码？</p>

</div>

<div id="verify_popup" style="height: 100%; width: 100%; position:fixed;top:0;z-index: 10;text-align: center;display:none; background-color: rgba(0,0,0,0.4);">

	<div id="popup_context" style="height: 4.79rem; width: 5.63rem; background: #FFFFFF;  margin: 3.33rem auto 0 auto; border-radius: 0.1rem 0.1rem 0.1rem 0.1rem; color: #e5ba7d; padding: 0.52rem 0.73rem 0 0.73rem; text-align: center;">
		<p style="margin-top: 0; font-size: 0.29rem; color: #333333;"> <b>收不到验证码</b></p>
		<p style="margin: 0.31rem 0 0 0;padding: 0; font-size: 0.25rem; color: #333333; text-align: left;">
			1.请检查短信是否被安全软件拦截
		</p>
		<p style="margin: 0.02rem 0 0 0;padding: 0; font-size: 0.25rem; color: #333333; text-align: left;">
			2.请确认手机信号是否良好
		</p>
		<p style="margin: 0.02rem 0 0 0;padding: 0; font-size: 0.25rem; color: #333333; text-align: left;">
			3.请确认当前手机号是否已停机或停用
		</p>
		<p style="line-height: 0.33rem; margin: 0.27rem 0 0 0;padding: 0; font-size: 0.25rem; color: #333333; text-align: left;">如有疑问，可以咨询<a href="tel:4006-717-656" style="margin-top: 0.02rem; font-size: 0.29rem; color: #268ef9; text-align: left; ">4006-717-656</a></p>
		<!--<div style="text-align: left; margin-top: 0.06rem;">
			<a href="tel:400-9690-198" style="margin-top: 0.02rem; font-size: 0.29rem; color: #268ef9; text-align: left; ">400-9690-198</a>
		</div>-->
		<div id='cancel_popup_button' style="position: relative; height: 0.52rem; line-height: 0.52rem; width: 2.5rem;  background: #FB5237; text-align: center; margin: 0.21rem auto 0 auto; border-radius: 0.63rem; color: #FFFFFF; font-size: 0.27rem;">
			我知道了
		</div>
	</div>
</div>
<div id='welcome_view' style="position: fixed; display: none; top: 0; height: 100%; width: 100%; background: rgba(0,0,0,0.4); z-index: 999;">
	<img src="../images/beijingguang.png" style="height: 7.08rem; width: 100%; position: fixed; top: 0; left: 0; right: 0; margin: auto;" />
	<div style="position: fixed; top: 4.54rem; left: 0; right: 0; height: 3.75rem; width: 5.21rem; border-radius: 0.21rem; background: #FFFFFF; margin:auto; text-align: center; z-index: 1;">
		<img src="../images/welcome_head.png" style="width: 4.02rem; position: relative; margin-top: -0.9rem;" />
		<div style="font-size: 0.31rem; color: #FB5237; margin-top: 0.17rem;"><b>营销合伙人</b></div>
		<div style="font-size: 0.27rem; color: #333333; margin-top: 0.21rem; line-height: 0.42rem;">您已获得 <span id="awardbean" style="color: #FB5237;">200 </span> 薪豆，赶快成为<br />营销合伙人开始您的赚钱之旅吧！</div>
		<img id="welcome_button" src="../images/welcome_button.png" style="width: 2.71rem; margin-top: 0.29rem;" />
	</div>
</div>
<script src="../js/mui.min.js"></script>
<script src="../js/app.js"></script>
<script type="text/javascript">
    var submitButton = document.getElementById('submit');
    var isSending = true;
    var isSubmitButtonClickable = false;

    var verifyCodeBox = document.getElementById('verifyCode');
    var passwordBox = document.getElementById('password');
    var sendVerifyButton = document.getElementById("sendcode_button");


    document.addEventListener('plusready', function() {
        //关闭上一个页面
        var opener = plus.webview.currentWebview().opener();
        mui.fire(opener, 'close', {});
        plus.screen.lockOrientation("portrait-primary");
        mui.init({
            swipeBack: true //启用右滑关闭功能
        });
        var userData = plus.webview.currentWebview();
        console.log(JSON.stringify(userData))
        countDownAction(60);

        var phonenumber = userData.cu_phonenumber;
        document.getElementById("phonenumberbox").innerText = phonenumber.substr(0, 3) + '****' + phonenumber.substr(7);

        sendVerifyButton.addEventListener('tap', function() {
            if(isSending) return;
            sendVerify(userData);
            countDownAction(60);
            sendVerifyButton.style.backgroundColor = "#eeeeee";
            sendVerifyButton.style.color = "#999999";
        });
        var isSubmitting = false;
        submitButton.addEventListener('tap', function() {
            if(!isSubmitButtonClickable) {
                if((!passwordBox.value) || passwordBox.value.length == 0) {
                    plus.nativeUI.toast('请输入密码');
                }
                if((!verifyCodeBox.value) || verifyCodeBox.value.length == 0) {
                    plus.nativeUI.toast('请输入验证');
                }
                return;
            }
            if(!check(passwordBox.value)) {
                plus.nativeUI.toast("密码应为6-20位，需要同时包含字母和数字");
                return;
            }

            if(isSubmitting == true) {
                return;
            }
            isSubmitting = true;

            var url = getBaseUrl() + 'user/ClientUser/register';
            console.log(url);
            mui.ajax(url, {
                data: {
                    cu_phonenumber: userData.cu_phonenumber, //手机号
                    invitation_code: userData.invitation_code, //验证码
                    verification_code: verifyCodeBox.value, //验证码
                    source: 'app',
                    cu_password: passwordBox.value
                },
                dataType: 'json',
                type: 'post', //HTTP请求类型
                timeout: 10000, //超时时间设置为10秒；
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function(data) {
                    console.log(JSON.stringify(data));
                    if(data.status == 'success') {
                        mui.toast("注册成功", {
                            type: 'div'
                        });
                        loginFunc();
                    } else {
                        mui.alert(data.error_code, '注册失败', '我知道了', function() {
                            isSubmitting = false;
                            //mui.back();
                        }, 'div');
                    }
                },
                error: function(xhr, type, errorThrown) {
                    isSubmitting = false;
                    console.log(JSON.stringify(xhr));
                }
            });

        });

        //监听文本框的输入事件，以判断登录按钮是否可点
        passwordBox.addEventListener('input', function() {
            //					console.log(accountBox.value);
            var flag = true;
            if((!passwordBox.value) || passwordBox.value.length == 0) flag = false;
            if((!verifyCodeBox.value) || verifyCodeBox.value.length == 0) flag = false;
            if(flag) {
                submitButton.style.backgroundColor = "#fb5237";
                submitButton.style.color = "#ffffff";
                isSubmitButtonClickable = true;
            } else {
                submitButton.style.backgroundColor = "#eeeeee";
                submitButton.style.color = "#999999";
                isSubmitButtonClickable = false;
            }

        });

        verifyCodeBox.addEventListener('input', function() {
            //					console.log(passwordBox.value);
            var flag = true;
            if((!passwordBox.value) || passwordBox.value.length == 0) flag = false;
            if((!verifyCodeBox.value) || verifyCodeBox.value.length == 0) flag = false;
            if(flag) {
                submitButton.style.backgroundColor = "#fb5237";
                submitButton.style.color = "#ffffff";
                isSubmitButtonClickable = true;
            } else {
                submitButton.style.backgroundColor = "#eeeeee";
                submitButton.style.color = "#999999";
                isSubmitButtonClickable = false;
            }
        });

        function sendVerify(userData) { //请求服务器发送验证码
            var sendurl = getBaseUrl() + 'user/ClientUser/sms';
            mui.ajax(sendurl, {
                data: {
                    cu_phonenumber: userData.cu_phonenumber,
                    invitation_code: userData.invitation_code
                },
                dataType: 'json',
                type: 'post', //HTTP请求类型
                timeout: 10000, //超时时间设置为10秒；
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function(data) {
                    console.log("resend success");
                },
                error: function(xhr, type, errorThrown) {
                    console.log(JSON.stringify(xhr));
                    console.log(type);
                    console.log(JSON.stringify(errorThrown));
                }
            });
        }

        function countDownAction(seconds) {
            //倒计时功能
            var timer = window.setInterval(function() {
                sendVerifyButton.innerText = ('' + seconds + "S后可重发");
                if(seconds == 0) {
                    clearInterval(timer);
                    sendVerifyButton.style.backgroundColor = "#FB5237";
                    sendVerifyButton.style.color = "#ffffff";
                    sendVerifyButton.innerText = ("发送验证码");
                    isSending = false;
                }
                seconds--;
            }, 1000);
        }

        function loginFunc() {
            var url = getBaseUrl() + 'user/ClientUser/login';
            console.log(">>>>>>>>>>>>>>login url:" + url);
            mui.ajax(url, {
                data: {
                    cu_phonenumber: userData.cu_phonenumber,
                    cu_password: passwordBox.value
                },
                dataType: 'json', //服务器返回json格式数据
                type: 'post', //HTTP请求类型
                timeout: 10000, //超时时间设置为10秒；
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function(data) {
                    console.log("成功");
                    console.log(JSON.stringify(data));
                    if(data.status == 'success') {
                        //登录成功，跳转到主页，若以后加了安全验证，在此处写jessionId
                        localStorage.userId = data.cu_id;
                        console.log(data.cu_id);
                        localStorage.phonenumber = userData.cu_phonenumber;
                        localStorage.password = passwordBox.value;
                        localStorage.islogin = "1";
                        var market = parseInt(data.marketing_partner);
                        if(market == 1 && data.isPop == '1') {
                            localStorage.isPartner = 1;
                        } else {
                            localStorage.isPartner = 0;
                        }

                        var register_send_verify_code = plus.webview.getWebviewById('login');
                        mui.fire(register_send_verify_code, 'close', {});

                        var homepage = plus.webview.getWebviewById('html/homepage.html');
                        mui.fire(homepage, 'initpage', {});
                        var mypage = plus.webview.getWebviewById('html/mypage.html');
                        mui.fire(mypage, 'initpage', {});
                        var fanspage = plus.webview.getWebviewById('html/fanspage.html');
                        mui.fire(fanspage, 'initpage', {});
                        var taskpage = plus.webview.getWebviewById('html/taskpage.html');
                        mui.fire(taskpage, 'initpage', {});
                        mui.fire(plus.webview.getWebviewById("html/fanspage.html"), "refreshallmessagecount", {});

                        if(data.is_first_login == '0') {
                            document.getElementById("awardbean").innerHTML = data.bean;
                            document.getElementById("welcome_view").style.display = 'block';
                        }
                        else {
                            mui.back();
                        }
                    } else {
                        mui.back();
                    }
                },
                error: function(xhr, type, errorThrown) {
                    //异常处理；
                    console.log(JSON.stringify(xhr));
                    console.log(type);
                }
            });
        }

        document.getElementById("welcome_view").addEventListener('tap', function(e) {
            var target = $(e.target);
            if($(target).is("#welcome_view, #welcome_button")) {
                document.getElementById("welcome_view").style.display = 'none';
                plus.webview.currentWebview().close();
            }
        });

        document.getElementById("noverify").addEventListener('tap', function() {
            $("input").blur();
            document.getElementById("verify_popup").style.display = "block";
        });
        document.getElementById("verify_popup").addEventListener('tap', function(e) {
            var target = $(e.target);
            if($(target).is("#verify_popup, #cancel_popup_button")) {
                document.getElementById("verify_popup").style.display = "none";
            }
        });
    });
</script>
</body>

</html>